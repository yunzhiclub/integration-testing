name: GitHub Actions
run-name: integration-testing

on:
  pull_request:
    branches: [ main ]

jobs:
  unit-test:
    runs-on: ubuntu-latest

    # 定义任务的步骤
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.16.0

      - name: angular-test
        run: |
          pwd
          cd web
          env
          pwd
          npm install
          npm run test -- --no-watch --no-progress --browsers=ChromeHeadlessCI
          npm run build

  dingding-error:
    runs-on: ubuntu-latest
    needs: [ unit-test ]
    if: ${{ failure() }}
    steps:
      - name: Send dingding notify error
        uses: zcong1993/actions-ding@master
        with:
          dingToken: 8153de07f66891c86efaf01a8af8232d63a4000fc8c1949ecd7ac3091df53252
          body: |
            {
               "msgtype": "json",
               "json": {
                   "content": '[微笑][微笑][微笑] 前台未测试 执行成功\n提交者: ${{ github.triggering_actor }}\n任务: ${{ github.event.pull_request.title }}\n${{ github.ref_type }}: ${{ github.head_ref }}\n${{ github.event_name }}: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.number }}'
               }
             }

  dingding-success:
    runs-on: ubuntu-latest
    needs: [ unit-test ]
    if: ${{ success() }}
    steps:
      - name: Send dingding notify success
        uses: zcong1993/actions-ding@master
        with:
          dingToken: 8153de07f66891c86efaf01a8af8232d63a4000fc8c1949ecd7ac3091df53252
          body: |
            {
              "msgtype": "json",
              "json": {
                  "content": '[微笑][微笑][微笑] 前台未测试 执行成功\n提交者: ${{ github.triggering_actor }}\n任务: ${{ github.event.pull_request.title }}\n${{ github.ref_type }}: ${{ github.head_ref }}\n${{ github.event_name }}: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.number }}'
              }
            }