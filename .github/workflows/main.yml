name: GitHub Actions
run-name: integration-testing

on:
  pull_request:
    branches: [ main ]

jobs:
  unit-test:
    runs-on: ubuntu-latest

    # 定义任务的步骤
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.16.0

      - name: angular-test
        run: |
          pwd
          cd web
          env
          pwd
          npm install
          npm run test -- --no-watch --no-progress --browsers=ChromeHeadlessCI
          npm run build

  dingding-error:
    runs-on: ubuntu-latest
    needs: [ unit-test ]
    if: ${{ failure() }}
    steps:
      - name: Send dingding notify error
        uses: zcong1993/actions-ding@master
        with:
          dingToken: 8153de07f66891c86efaf01a8af8232d63a4000fc8c1949ecd7ac3091df53252
          body: |
            {
              "msgtype": "link",
              "link": {
              "text": "这个即将发布的新版本，创始人陈航（花名“无招”）称它为“红树林”。而在此之前，每当面临重大升级，产品经理们都会取一个应景的代号，这一次，为什么是“红树林”？",
              "title": "时代的火车向前开",
              "picUrl": "",
            }

  dingding-success:
    runs-on: ubuntu-latest
    needs: [ unit-test ]
    if: ${{ success() }}
    steps:
      - name: Send dingding notify success
        uses: zcong1993/actions-ding@master
        with:
          dingToken: 8153de07f66891c86efaf01a8af8232d63a4000fc8c1949ecd7ac3091df53252
          body: |
            {
              "msgtype": "link",
              "link": {
              "text": "这个即将发布的新版本，创始人陈航（花名“无招”）称它为“红树林”。而在此之前，每当面临重大升级，产品经理们都会取一个应景的代号，这一次，为什么是“红树林”？",
              "title": "时代的火车向前开",
              "picUrl": "",
            }